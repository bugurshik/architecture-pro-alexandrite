# Мотивация
- Выявлять и предотвращать сбои до того, как они повлияют на пользователей или нанесут вред системе.
- Оптимизировать ресурсы, отслеживая нагрузку на серверы, базы данных и очереди сообщений.
- Улучшить контроль качества, наблюдая за количеством ошибок и скоростью работы API. 

# Выбор подхода к мониторингу

## Shop API - SRE
Для Shop API Выбран подход 'Четыре золотых сигнала' (Задержка, Траффик, Ошибки, Насыщенность)
Данный подход хорошо работает для продуктовых API, и фокусируется на внешнем восприятии сервиса

## Инфраструктурные компоненты - USE
Для таких сервисов как: Shop DB, MES DB, 3d Files storage, Message Queue.
Очень важна стабильность, и доступность ресурсов. 
Для инфраструктуных компонентов выбран подход USE.
Данный подход обеспечивает наблюдение за потребляемыми ресурсами и ошибками, что позволяет не пропустить момент, когда системе понадобится масштабирование. 

## Внутренние API - RED
Для CRM API и MES API выбран подход RED.
Это внутренние сервисы компании, для которых важным является стабильность и предсказуемость.
Данный подход как раз делает фокус на производительности и стабильности сервиса.
Прост для внедрения, и позволяет быстро диагностировать проблемы.
Простные явные сигналы - увеличение количества запросов, ошибок или длительности ответа, в большинстве случаев говорит о проблемах (или что они могут скоро возникнуть) 

# Наблюдаемые метрики:

## Метрики Shop API
|Метрика|Ярлык|Комментарий|
|--|--|--|
|Response time (latency) for shop API|status_code, endpoint|Позволяет понимать, насколько быстро система отвечает на запросы. Высокая задержка может свидетельствовать о проблемах в логике API, базе данных или сетевой инфраструктуре|
|Number of requests (RPS) for internet shop API, <br>Number of requests (RPS) per user for internet shop API, <br>Kb provided (sent) for shop API|endpoint|Позволяет анализировать нагрузку на систему и выявлять аномалии. Также помогает в планировании масштабирования|
|Number of HTTP 500 for shop API|endpoint|Позволяет отслеживать количество внутренних ошибок, что критично для обеспечения надёжности сервисов|
|Number of simultanious sessions for shop API||Позволяет оценить, насколько система приближается к своему пределу по нагрузке|

## Метрики CRM И MES

|Метрика|Ярлык|Комментарий|
|--|--|--|
|Response time (latency) for CRM API, <br>Response time (latency) for MES API|status_code, endpoint|Позволяет понимать, насколько быстро система отвечает на запросы. Высокая задержка может свидетельствовать о проблемах в логике API, базе данных или сетевой инфраструктуре|
|Number of requests (RPS) per user for MES API|status_code, endpoint||
|Number of HTTP 500 for CRM API, <br>Number of HTTP 500 for MES API|endpoint|Позволяет отслеживать количество внутренних ошибок, что критично для обеспечения надёжности сервисов|

## Метрики инфраструктуры
|Метрика|Ярлык|Комментарий |
|--|--|--|
|Memory Utilisation for shop db instance, <br>Memory Utilisation for MES db instance||Нужна для контроля использования оперативной памяти экземпляром базы данных, чтобы обеспечить стабильную работу, вовремя выявить перегрузку или простой, и оптимизировать ресурсы|
|Number of connections for shop db instance, <br>Number of connections for MES db instance||PostgesQL имеет лимиты на количество активных подключений, нужно следить за этой метрикой для оперативного масштабирования|
|Size of S3 storage|bucket_name|Небходимо наблюдать за оставшимся доступным объёмом хранилища для избежания блокирования системы (как минимум на запись)|
|Size of shop db instance, <br>Size of MES db instance||Небходимо наблюдать за оставшимся доступным объёмом хранилища для избежания блокирования системы (как минимум на запись)|
|Number of dead-letter-exchange letters||Наблюдение за исправностью очереди сообщений и потребителями |

# План действий
## 1. Подготовка инфраструктуры
- Создать базу данных Prometheus для хранения метрик, 
- Развернуть систему визуализации Grafana 
## 2. Интеграция
- Добавить middleware в API (Shop, CRM, MES) для сбора метрик
- Добавить экспортеры метрик для PostgreSQL, RabbitMQ, S3
## 3. Создание дашбордов
- Создать дашборд для каждого из сервисов Shop API, CRM, MES
- Создать дашборд для инфраструктурных сервисов (connections, memory, size)
- Создать Overview дашборд с базовыми метриками (Ошибки, трафик, количество запросов)

# Показатели насыщения
Показатели того, насколько система приближается к своему пределу по нагрузке:

|Метрика|Пороговое значение|Комментарий|
|--|--|--|
|Number of simultanious sessions|90% от максимально допустимого числа| При превышении система начинает терять запросы или отвечать медленно|
|Number of connections|90% от max_connections|PostgreSQL имеют лимиты на число подключений|
|Number of message in flight|1000 сообщений| Сигнал о том, что обработчики не справляются с нагрузкой|
|Number of dead-letter-exchange letters| >100 сообщений | Сигнал о постоянных ошибках в обработке сообщений|
|Response time (latency)| 95-й перцентиль > 1000 мс | Система не справляется с запросами вовремя|

